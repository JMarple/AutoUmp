#include <xs1.h>
#include <platform.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "ov07740.h"
#include "io.h"
#include "algs.h"

extern in buffered port:32 cam1DATA;
extern in buffered port:32 cam2DATA;

uint8_t glbBitImages[25][320*240/8];

void dataCapturingTemporaryThread(interface MasterToFloodFillInter server mtff)
{
    int lc = 0;
    while (1==1)
    {
        select
        {
            case mtff.sendBitBuffer(uint8_t tmpBitBuf[], uint32_t n):
                memcpy(glbBitImages[lc++], tmpBitBuf, n*sizeof(uint8_t));
                break;
        }
    }
}

// "UI" tile
void Tile0(chanend bluetoothChan)
{
    par
    {
        BluetoothThread(bluetoothChan);
    }
}

struct DenoiseLookup luTile1;

uint8_t gblBitImage10[320*240/8];
uint8_t gblBitImage20[320*240/8];

// "Camera" tile
void Tile1(chanend bluetoothChan)
{ unsafe {

    printf("Booting AutoUmp...\n");

    OV07740_InitCameras();
    OV07740_ConfigureCameras();

    interface MasterToFloodFillInter mtff[2];

    streaming chan cmdStream1, cmdStream2;
    chan ffStream1, ffStream2;
    chan doStream1, doStream2; // detected objects

    struct Object objArray1[OBJECT_ARRAY_LENGTH];
    struct Object objArray2[OBJECT_ARRAY_LENGTH];

    initObjectArray(objArray1, OBJECT_ARRAY_LENGTH);
    initObjectArray(objArray2, OBJECT_ARRAY_LENGTH);

    struct Queue queue1;
    struct Queue queue2;
    queueInit(&queue1);
    queueInit(&queue2);

    // used to send information over via bluetooth
    uint8_t objInfo1[OBJECT_ARRAY_LENGTH*12];
    uint8_t objInfo2[OBJECT_ARRAY_LENGTH*12];
    for (int i = 0; i < OBJECT_ARRAY_LENGTH*12; i++)
    {
        objInfo1[i] = 0;
        objInfo2[i] = 0;
    }

    struct DenoiseLookup* unsafe lu = &luTile1;//(struct DenoiseLookup* unsafe) malloc(sizeof(struct DenoiseLookup));

    if (lu == 0) printf("Lookup table out of memory!");

    DenoiseInitLookup(lu);

    par
    {
        OV07740_MasterThread(
            cmdStream1, cmdStream2,
            ffStream1, ffStream2,
            bluetoothChan,
            (uint8_t* unsafe)objInfo1, (uint8_t* unsafe)objInfo2, mtff);

        OV07740_GatherDataThread(cmdStream1,
            (port* unsafe)&cam1DATA);

        OV07740_GatherDataThread(cmdStream2,
            (port* unsafe)&cam2DATA);

        FloodFillThread(
            ffStream1,
            mtff[0],
            objArray1,
            &queue1,
            (uint8_t* unsafe)objInfo1,
            gblBitImage10, lu);

        FloodFillThread(
            ffStream2,
            mtff[1],
            objArray2,
            &queue2,
            (uint8_t* unsafe)objInfo2,
            gblBitImage20, lu);
    }
}}

int main()
{
    chan bluetoothChan;

    par
    {
        on tile[0]: Tile0(bluetoothChan);
        on tile[1]: Tile1(bluetoothChan);
    }
    return 0;
}
